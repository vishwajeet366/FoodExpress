{% extends "index.html" %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="dashboard-card mb-4">
            <div class="text-center">
                <div class="credit-badge {{ 'credit-' + session.credit_status }} mb-3">
                    <i class="fas fa-star"></i> Score: {{ session.credit_score }}
                </div>
                <p class="small text-muted">
                    Your current discount: <strong>{{ discount }}%</strong>
                </p>
            </div>
            
            <hr>
            
            <div class="nav flex-column nav-pills">
                <a class="nav-link" href="{{ url_for('customer_dashboard') }}">
                    <i class="fas fa-home mr-2"></i> Dashboard
                </a>
                <a class="nav-link active" href="/customer/orders">
                    <i class="fas fa-shopping-bag mr-2"></i> My Orders
                </a>
                <a class="nav-link" href="/customer/profile">
                    <i class="fas fa-user-circle mr-2"></i> Profile
                </a>
            </div>
        </div>
        
        <div class="dashboard-card">
            <h6><i class="fas fa-chart-line"></i> Order Statistics</h6>
            <div class="mt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span>Total Orders:</span>
                    <strong>{{ user.total_orders or 0 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Completed:</span>
                    <strong class="text-success">{{ user.completed_orders or 0 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Cancelled:</span>
                    <strong class="text-danger">{{ user.cancelled_orders or 0 }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Cancellation Rate:</span>
                    <strong>
                        {% if user.total_orders and user.total_orders > 0 %}
                            {{ (user.cancelled_orders * 100 / user.total_orders)|round(1) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </strong>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        <div class="dashboard-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-shopping-bag"></i> My Orders</h4>
                <div class="btn-group">
                    <button class="btn btn-outline-primary active" onclick="filterOrders('all')">All</button>
                    <button class="btn btn-outline-primary" onclick="filterOrders('pending')">Pending</button>
                    <button class="btn btn-outline-primary" onclick="filterOrders('delivered')">Delivered</button>
                    <button class="btn btn-outline-primary" onclick="filterOrders('cancelled')">Cancelled</button>
                </div>
            </div>
            
            {% if orders and orders|length > 0 %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Restaurant</th>
                            <th>Items</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable">
                        {% for order in orders %}
                        <tr data-status="{{ order.status }}">
                            <td><strong>#{{ order.order_number }}</strong></td>
                            <td>
                                {{ order.restaurant_name }}
                                {% if order.trust_badge %}
                                <span class="badge badge-success ml-1">✓</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewOrderItems({{ order.id }})">
                                    View Items
                                </button>
                            </td>
                            <td>₹{{ order.final_amount }}</td>
                            <td>
                                <span class="order-status status-{{ order.status }}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>{{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="#" class="btn btn-outline-info" 
                                       onclick="viewOrderDetails({{ order.id }})">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if order.status in ['pending', 'accepted', 'preparing'] %}
                                    <button class="btn btn-outline-danger" 
                                            onclick="cancelOrder({{ order.id }})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                    {% if order.status == 'delivered' %}
                                    <button class="btn btn-outline-success">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span class="text-muted">
                        Showing {{ orders|length }} orders
                    </span>
                </div>
                <nav>
                    <ul class="pagination pagination-sm">
                        <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">Next</a></li>
                    </ul>
                </nav>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                <h5>No Orders Yet</h5>
                <p class="text-muted">You haven't placed any orders yet.</p>
                <a href="{{ url_for('customer_dashboard') }}" class="btn btn-primary">
                    <i class="fas fa-utensils"></i> Start Ordering
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Credit History -->
        <div class="dashboard-card">
            <h5><i class="fas fa-history"></i> Credit History</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Old Score</th>
                            <th>New Score</th>
                            <th>Change</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="creditHistory">
                        <!-- Credit history loaded via JavaScript -->
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details #<span id="orderNumber"></span></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Order details loaded via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printOrder()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Items Modal -->
<div class="modal fade" id="orderItemsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Items</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="orderItemsContent">
                <!-- Order items loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadCreditHistory();
    });
    
    function filterOrders(status) {
        const rows = document.querySelectorAll('#ordersTable tr');
        const buttons = document.querySelectorAll('.btn-group .btn');
        
        // Update active button
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Filter rows
        rows.forEach(row => {
            if (status === 'all' || row.dataset.status === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function viewOrderDetails(orderId) {
        fetch(`/api/get_order_details/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.order;
                    document.getElementById('orderNumber').textContent = order.order_number;
                    
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Order Information</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Order ID:</th>
                                        <td>#${order.order_number}</td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td><span class="order-status status-${order.status}">${order.status}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Order Date:</th>
                                        <td>${new Date(order.created_at).toLocaleString()}</td>
                                    </tr>
                                    <tr>
                                        <th>Payment:</th>
                                        <td>${order.payment_method} - <span class="text-success">${order.payment_status}</span></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Amount Details</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th>Subtotal:</th>
                                        <td>₹${order.total_amount}</td>
                                    </tr>
                                    <tr>
                                        <th>Delivery:</th>
                                        <td>₹${order.delivery_fee}</td>
                                    </tr>
                                    <tr>
                                        <th>Discount:</th>
                                        <td class="text-success">-₹${order.discount_amount}</td>
                                    </tr>
                                    <tr class="font-weight-bold">
                                        <th>Total:</th>
                                        <td>₹${order.final_amount}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('orderDetailsContent').innerHTML = html;
                    $('#orderDetailsModal').modal('show');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error', 'Unable to load order details', 'error');
            });
    }
    
    function viewOrderItems(orderId) {
        fetch(`/api/get_order_items/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '<ul class="list-group">';
                    data.items.forEach(item => {
                        html += `
                            <li class="list-group-item d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1">${item.name}</h6>
                                    <small class="text-muted">₹${item.price} × ${item.quantity}</small>
                                </div>
                                <span class="font-weight-bold">₹${item.price * item.quantity}</span>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    
                    document.getElementById('orderItemsContent').innerHTML = html;
                    $('#orderItemsModal').modal('show');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error', 'Unable to load order items', 'error');
            });
    }
    
    function loadCreditHistory() {
        fetch('/api/get_user_stats')
            .then(response => response.json())
            .then(data => {
                const historyContainer = document.getElementById('creditHistory');
                if (data.history && data.history.length > 0) {
                    let html = '';
                    data.history.forEach(record => {
                        const changeClass = record.change_amount > 0 ? 'text-success' : 'text-danger';
                        const changeSymbol = record.change_amount > 0 ? '+' : '';
                        
                        html += `
                            <tr>
                                <td>${new Date(record.created_at).toLocaleDateString()}</td>
                                <td>${record.old_score}</td>
                                <td>${record.new_score}</td>
                                <td class="${changeClass}">
                                    ${changeSymbol}${record.change_amount}
                                </td>
                                <td>${record.reason}</td>
                            </tr>
                        `;
                    });
                    historyContainer.innerHTML = html;
                } else {
                    historyContainer.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-3 text-muted">
                                No credit history available
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('creditHistory').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-3 text-danger">
                            Error loading credit history
                        </td>
                    </tr>
                `;
            });
    }
    
    function printOrder() {
        window.print();
    }
</script>
{% endblock %}